<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤</title>

  <style>
    body { 
      margin:0;
      font-family:'Sarabun',sans-serif; 
      background:#fffaf5; 
    }

    /* üî• BG ‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏•‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏≤‡∏á */
    .bg-blur {
      position: fixed;
      inset: 0;
      background-size: cover;
      background-position: center;
      filter: blur(8px);
      opacity: 0.15;
      z-index: -1;
    }

    .overlay { 
      display:flex; 
      justify-content:center; 
      align-items:center; 
      height:100vh; 
      padding:20px;
    }

    .card { 
      background:white; 
      padding:30px; 
      border-radius:15px; 
      box-shadow:0 0 20px rgba(0,0,0,0.1); 
      text-align:center; 
      width:320px; 
    }

    .brand-logo {
      width:70px;
      height:70px;
      border-radius:10px;
      object-fit:cover;
      margin-bottom:10px;

      display:block;         /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç */
      margin-left:auto;      /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á */
      margin-right:auto;     /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á */

      display:none; /* ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ */
}

    .title {
      color:#f75d00;
      font-size:22px;
      margin:5px 0 3px 0;
      font-weight:700;
    }

    .concept {
      font-size:14px;
      margin-bottom:15px;
      color:#555;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box; /* ‚≠ê */
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 5px;
      box-sizing: border-box; /* ‚≠ê ‡∏Å‡∏±‡∏ô error layout */
    }

    button.main { background:#ffa733; color:white; }
    button.main:hover { background:#ff8c00; }

    .meta { 
      margin-top:12px; 
      font-size:13px; 
      color:#666; 
      line-height:1.5;
    }

    .admin-link { 
      margin-top:10px; 
      font-size:12px; 
      color:#999; 
      cursor:pointer; 
      text-decoration:underline; 
    }

    /* ===== Responsive Core ===== */
* {
  box-sizing: border-box;
}

body {
  -webkit-text-size-adjust: 100%;
}

img {
  max-width: 100%;
}

/* Card / Container */
.card,
.container,
.wrapper {
  max-width: 100%;
}

/* Buttons & inputs */
input, select, textarea, button {
  font-size: 16px; /* ‡∏Å‡∏±‡∏ô iOS zoom */
}

/* Mobile layout */
@media (max-width: 768px) {

  body {
    padding: 0;
  }

  .overlay {
    align-items: flex-start;
    padding: 12px;
  }

  .card {
    width: 100% !important;
    max-width: 420px;
    margin: 0 auto;
    padding: 20px;
    border-radius: 14px;
  }

  .title {
    font-size: 20px;
  }

  .concept {
    font-size: 13px;
  }

  button {
    padding: 14px;
    font-size: 16px;
  }

  input {
    padding: 14px;
    font-size: 16px;
  }
}
@media (max-width: 768px) {

  body {
    background:#fff;
  }

  .overlay {
    align-items: flex-start;
    padding-top: 30px;
  }

  .card {
    width: 100%;
    max-width: 420px;
    margin: 0 auto;
    border-radius: 20px;
    padding: 22px;
  }

  .brand-logo {
    width: 90px;
    height: 90px;
  }

  .title {
    font-size: 24px;
  }

  .concept {
    font-size: 14px;
  }

  input {
    font-size: 16px;
    padding: 14px;
    border-radius: 10px;
  }

  button {
    padding: 16px;
    border-radius: 12px;
    font-size: 16px;
  }

  #shopClosedBox h2 {
    font-size: 22px;
  }

  #shopClosedBox p {
    font-size: 14px;
  }
}
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    const supabaseUrl = "https://vxutzcrwqbnkcwxtdphy.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4dXR6Y3J3cWJua2N3eHRkcGh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzkzNDQsImV4cCI6MjA3NTA1NTM0NH0.zwbcu_4eGAiRTaX7QBwgrJhWgCda58FW-boeJM-ZlKg";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    function isWithinOpenTime(open, close) {
  if (!open || !close) return true;

  const now = new Date();
  const [oh, om] = open.split(":").map(Number);
  const [ch, cm] = close.split(":").map(Number);

  const start = new Date();
  start.setHours(oh, om, 0, 0);

  const end = new Date();
  end.setHours(ch, cm, 0, 0);

  return now >= start && now <= end;
}

    async function checkShopOpen() {
  const { data, error } = await supabaseClient
    .from("shop_settings")
    .select("is_open")
    .eq("id", 1)
    .maybeSingle();   // üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

  if (error) {
    console.error("checkShopOpen error", error);
    return true; // ‡∏ñ‡πâ‡∏≤ error ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î
  }

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ row ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î
  return data?.is_open !== false;
}

    /* =====================================================
       ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Table store_settings
    ===================================================== */
    async function loadStoreInfo() {
      const { data, error } = await supabaseClient
        .from("store_settings")
        .select("*")
        .eq("id", 1)
        .single();

      if (!data) return;

      // ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô
      if (data.logo_url) {
        const logo = document.getElementById("storeLogo");
        logo.src = data.logo_url;
        logo.style.display = "block";
      }

      // ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
      document.getElementById("storeTitle").innerText = data.store_name || "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤";

      // Concept ‡∏£‡πâ‡∏≤‡∏ô
      document.getElementById("storeConcept").innerText = data.store_concept || "";

      // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î + Line
      document.getElementById("storeMeta").innerHTML =
        `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î: ${data.open_time} - ${data.close_time}<br>LINE ID: ${data.line_id}`;

      // üåÑ Background ‡∏£‡πâ‡∏≤‡∏ô
      if (data.store_background) {
        const bg = document.getElementById("bgImage");
        bg.style.backgroundImage = `url('${data.store_background}')`;
      }
    }

    async function goToMenu() {
  try {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô
    const { data: shop } = await supabaseClient
      .from("shop_settings")
      .select("is_open")
      .eq("id", 1)
      .maybeSingle();   // üî•

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ row ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î
    const isOpen = shop?.is_open !== false;

    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (optional)
    const { data: store } = await supabaseClient
      .from("store_settings")
      .select("open_time, close_time")
      .eq("id", 1)
      .maybeSingle();   // üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

    const timeOK = store
      ? isWithinOpenTime(store.open_time, store.close_time)
      : true;          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß = ‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å

    if (!isOpen || !timeOK) {
      alert("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏à‡πâ‡∏≤ üôè");
      return;
    }

    const house = document.getElementById("houseNumber").value.trim();
    if (!house) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà");

    localStorage.setItem("houseNumber", house);
    window.location.href = "Menu.html";

  } catch (err) {
    console.error("goToMenu error", err);
    alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
  }
}

    async function checkOrder() {
      let houseNo = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå");
      if (!houseNo) return;

      localStorage.setItem("houseNumber", houseNo);

      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
      const startOfToday = new Date();
      startOfToday.setHours(0, 0, 0, 0);

      const endOfToday = new Date();
      endOfToday.setHours(23, 59, 59, 999);

      const { data, error } = await supabaseClient
       .from("orders")
       .select("id")
       .eq("house", houseNo)
       .not("status", "eq", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å")
       .gte("created_at", startOfToday.toISOString())
       .lte("created_at", endOfToday.toISOString())
       .order("created_at", { ascending: false })
       .limit(1)
       .single();

      if (error || !data) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ\n‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô");
        return;
      }

      // ‚úÖ ‡πÄ‡∏à‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Üí ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      localStorage.setItem("currentOrderId", data.id);
      window.location.href = "order-status.html";
    }

    function subscribeShopStatusRealtime() {
  supabaseClient
    .channel("shop-settings-realtime")
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "shop_settings", filter: "id=eq.1" },
      () => initIndex()
    )
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "store_settings", filter: "id=eq.1" },
      () => initIndex()
    )
    .subscribe();
}

    let shopRealtimeStarted = false;

async function initIndex() {
  const isOpen = await checkShopOpen();

  const orderBox = document.getElementById("orderSection");
  const closedBox = document.getElementById("shopClosedBox");

  if (!isOpen) {
    orderBox.style.display = "none";
    closedBox.style.display = "block";
  } else {
    orderBox.style.display = "block";
    closedBox.style.display = "none";
  }

  loadMenus();
  loadOptions();
}

    window.onload = async () => {
  await loadStoreInfo();
  await initIndex();
  subscribeShopStatusRealtime();   // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
};
  </script>

</head>
<body>

  <!-- üî• BG ‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏á + ‡πÄ‡∏ö‡∏•‡∏≠ -->
  <div id="bgImage" class="bg-blur"></div>

  <div class="overlay">
    
    <div class="card">

      <!-- üîπ ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏£‡πâ‡∏≤‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î) -->
      <img id="storeLogo" class="brand-logo" />
      <div id="storeTitle" class="title"></div>
      <div id="storeConcept" class="concept"></div>

      <!-- üîπ ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ -->
      <div id="orderSection">
        <input type="text" id="houseNumber" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
        <button class="main" onclick="goToMenu()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
        <button onclick="checkOrder()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
      </div>

      <!-- üîπ ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î -->
      <div id="shopClosedBox" style="display:none;text-align:center;padding:20px;">
        <h2>üö´ ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤ üö´</h2>
        <p>üôè ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å üôè</p>
      </div>

      <!-- üîπ footer ‡∏£‡πâ‡∏≤‡∏ô -->
      <div id="storeMeta" class="meta"></div>

      </div>
    </div>
  </div>

</body>
</html>
