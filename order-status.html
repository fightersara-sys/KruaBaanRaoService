<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå - ‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  /* --- üé® ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å (CSS) --- */
  :root {
    --primary: #ff6600;
    --primary-light: #fff3e6;
    --success: #28a745;
    --danger: #dc3545;
    --gray: #888;
    --bg: #fffaf5;
    --card-shadow: 0 4px 20px rgba(0,0,0,0.06);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Tahoma', sans-serif; background: var(--bg); margin: 0; color: #333; line-height: 1.5; }

  header { 
    background: var(--primary); color: white; padding: 15px; 
    text-align: center; font-size: 20px; font-weight: bold;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: sticky; top: 0; z-index: 100;
  }

  .container { max-width: 800px; margin: 20px auto; padding: 0 15px 50px; }

  /* --- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --- */
  .order-card { 
    background: white; border-radius: 20px; padding: 25px; 
    box-shadow: var(--card-shadow); margin-bottom: 25px;
    border-top: 6px solid var(--primary);
  }

  .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
  .info-item { background: var(--primary-light); padding: 12px; border-radius: 15px; border: 1px solid #fde5d6; }
  .info-item .label { font-size: 11px; color: var(--gray); text-transform: uppercase; font-weight: bold; }
  .info-item .value { font-weight: bold; font-size: 16px; margin-top: 4px; color: #444; }

  .status-badge { 
    text-align: center; padding: 15px; border-radius: 15px; 
    font-weight: bold; font-size: 20px; margin-top: 10px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
  }
  .status-waiting { background: #fff3e6; color: #ff6600; }
  .status-cooking { background: #fff7cc; color: #997300; }
  .status-shipping { background: #e6f7ff; color: #0050b3; }
  .status-done { background: #f6ffed; color: #389e0d; }
  .status-cancel { background: #fff1f0; color: #cf1322; }

  /* --- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ --- */
  .section-title { font-size: 18px; color: var(--primary); margin: 30px 0 15px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
  .menu-list { background: white; border-radius: 20px; padding: 10px 20px; box-shadow: var(--card-shadow); }
  .menu-item { display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #f2f2f2; }
  .menu-item:last-child { border-bottom: none; }
  .menu-thumb { width: 80px; height: 80px; border-radius: 15px; object-fit: cover; background: #eee; }
  .menu-details { flex: 1; }
  .menu-name { font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; }
  .menu-options { font-size: 13px; color: var(--gray); margin-top: 5px; }
  .menu-total { text-align: right; color: var(--primary); font-weight: bold; margin-top: 8px; border-top: 1px dashed #eee; padding-top: 5px; }

  /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô --- */
  .payment-card { 
    background: white; border-radius: 20px; padding: 25px; 
    box-shadow: var(--card-shadow); margin-top: 25px;
  }
  .pay-method-box { border: 2px dashed #fde5d6; padding: 20px; border-radius: 15px; text-align: center; background: #fffdfb; }

  /* --- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° --- */
  .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px; }
  .btn { 
    padding: 15px; border-radius: 15px; border: none; font-size: 15px; font-weight: bold;
    cursor: pointer; text-align: center; transition: 0.2s;
  }
  .btn-primary { background: var(--primary); color: white; grid-column: span 2; }
  .btn-outline { background: white; color: var(--gray); border: 1px solid #ddd; }
  .btn-danger { background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; }
  .btn:active { transform: scale(0.96); }

  /* --- Modal --- */
  .overlay { 
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
    backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center;
  }
  .modal { background: white; width: 95%; max-width: 450px; border-radius: 25px; padding: 30px; animation: slideUp 0.3s; }
  @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  img.qr-img { width: 100%; max-width: 250px; display: block; margin: 15px auto; border: 1px solid #eee; padding: 10px; border-radius: 15px; background: white; }
  img.delivery-img { width: 100%; border-radius: 15px; margin-top: 10px; box-shadow: var(--card-shadow); }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
</head>
<body>

<header>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</header>

<div class="container" id="mainContainer">
  <div class="order-card">
    <div class="info-grid">
      <div class="info-item">
        <div class="label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
        <div class="value" id="orderId">-</div>
      </div>
      <div class="info-item">
        <div class="label">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</div>
        <div class="value" id="house">-</div>
      </div>
      <div class="info-item">
        <div class="label">‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
        <div class="value" id="queue" style="color:var(--primary); font-size:22px;">-</div>
      </div>
      <div class="info-item">
        <div class="label">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
        <div class="value" id="grandTotalText">‡∏ø0</div>
      </div>
    </div>
    <div id="statusBadge" class="status-badge status-waiting">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</div>
  </div>

  <div class="section-title">üçõ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</div>
  <div class="menu-list" id="menuList">
    <div style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£...</div>
  </div>

  <div class="payment-card">
    <div class="section-title" style="margin-top:0;">üí≥ ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
    <div id="paymentContent" class="pay-method-box"></div>
    <div id="deliverySection"></div>
  </div>

  <div class="btn-group">
    <button class="btn btn-primary" id="btnAdd" onclick="addMore()">üçõ ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    <button class="btn btn-outline" id="btnEdit" onclick="editOrder()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
    <button class="btn btn-danger" id="btnCancel" onclick="confirmCancelOrder()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
    <button class="btn btn-outline" style="grid-column: span 2;" onclick="backHome()">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
  </div>
</div>

<div id="overlay" class="overlay" onclick="if(event.target==this) closeOverlay()">
  <div class="modal" id="modalBox">
    <div id="modalContent"></div>
  </div>
</div>

<script>
const supabaseUrl = "https://vxutzcrwqbnkcwxtdphy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4dXR6Y3J3cWJua2N3eHRkcGh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzkzNDQsImV4cCI6MjA3NTA1NTM0NH0.zwbcu_4eGAiRTaX7QBwgrJhWgCda58FW-boeJM-ZlKg";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
const DEFAULT_IMG = "https://vxutzcrwqbnkcwxtdphy.supabase.co/storage/v1/object/public/Logo/logo.png";

let orderId = Number(localStorage.getItem("currentOrderId"));
let currentOrder = null;
let latestStoreQRUrl = null;
let menuImageMap = {}; 
let optionMap = {};

// --- üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---

async function init() {
  if (!orderId) {
    document.getElementById("mainContainer").innerHTML = `
      <div class="order-card" style="text-align:center;">
        <h3 style="color:var(--gray);">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
        <button class="btn btn-primary" onclick="backHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      </div>`;
    return;
  }

  try {
    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏Ç‡∏ô‡∏≤‡∏ô‡∏Å‡∏±‡∏ô)
    await Promise.all([
      loadMenuImages(),
      loadOptions(),
      loadStoreQR()
    ]);
    
    // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    await loadOrder();
    
    // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Real-time
    subscribeRealtime();
  } catch (err) {
    console.error("Init Error:", err);
  }
}

async function loadMenuImages() {
  const { data } = await supabaseClient.from("menus").select("id, image_url");
  if (data) data.forEach(m => menuImageMap[m.id] = m.image_url || DEFAULT_IMG);
}

async function loadOptions() {
  const { data } = await supabaseClient.from("options").select("id, name, price");
  if (data) data.forEach(o => optionMap[o.id] = { name: o.name, price: Number(o.price || 0) });
}

async function loadStoreQR() {
  const { data } = await supabaseClient.storage.from("payment-qr").list("", { limit: 1, sortBy: { column: "created_at", order: "desc" } });
  if (data?.length > 0) {
    const { data: url } = supabaseClient.storage.from("payment-qr").getPublicUrl(data[0].name);
    latestStoreQRUrl = url.publicUrl;
  }
}

async function loadOrder() {
  const { data, error } = await supabaseClient.from("orders").select("*").eq("id", orderId).single();
  if (data) {
    currentOrder = data;
    renderOrder(data);
  }
}

// --- üñºÔ∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---

function formatOrderId(o) {
  try {
    const id = o.id || 0;
    const d = o.created_at ? new Date(o.created_at) : new Date();
    const dateStr = d.toISOString().slice(0, 10).replace(/-/g, "");
    return `${dateStr}-${String(id).padStart(5, "0")}`;
  } catch (e) { return `#${o.id}`; }
}

function renderOrder(o) {
  document.getElementById("orderId").innerText = formatOrderId(o);
  document.getElementById("house").innerText = o.house || "-";
  document.getElementById("queue").innerText = o.queue_number ? `#${o.queue_number}` : "-";
  
  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Badge ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  const badge = document.getElementById("statusBadge");
  const status = o.status || "‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå";
  badge.innerText = status;
  badge.className = "status-badge";
  if (status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£") badge.classList.add("status-cooking");
  else if (status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á") badge.classList.add("status-shipping");
  else if (status === "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß" || status === "‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß") badge.classList.add("status-done");
  else if (status === "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å") badge.classList.add("status-cancel");
  else badge.classList.add("status-waiting");

  // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£
  const list = document.getElementById("menuList");
  list.innerHTML = "";
  let totalCalculated = 0;

  (o.items || []).forEach(it => {
    const qty = Number(it.qty || 1);
    const basePrice = Number(it.price || 0);
    let optTotal = 0;
    let optLines = "";

    if (it.options) {
      let opts = Array.isArray(it.options) ? it.options : [];
      opts.forEach(opt => {
        const oPrice = Number(opt.price || 0);
        optTotal += oPrice;
        optLines += `<div>- ${opt.name} ${oPrice > 0 ? `<span style="color:var(--primary);">+‡∏ø${oPrice}</span>` : ""}</div>`;
      });
    }

    const itemTotal = (basePrice + optTotal) * qty;
    totalCalculated += itemTotal;

    const row = document.createElement("div");
    row.className = "menu-item";
    row.innerHTML = `
      <img class="menu-thumb" src="${menuImageMap[it.menu_id] || DEFAULT_IMG}" onerror="this.src='${DEFAULT_IMG}'">
      <div class="menu-details">
        <div class="menu-name">
          <span>${qty} √ó ${it.food}</span>
          <span style="font-weight:normal; color:var(--gray);">‡∏ø${basePrice.toLocaleString()}</span>
        </div>
        <div class="menu-options">${optLines || '<span style="color:#ccc;">- ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</span>'}</div>
        ${it.note ? `<div style="color:orange; font-size:12px; margin-top:3px;">üìù ${it.note}</div>` : ""}
        <div class="menu-total">‡∏£‡∏ß‡∏° ‡∏ø${itemTotal.toLocaleString()}</div>
      </div>
    `;
    list.appendChild(row);
  });

  document.getElementById("grandTotalText").innerText = `‡∏ø${totalCalculated.toLocaleString()}`;

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
  const payBox = document.getElementById("paymentContent");
  if (o.payment_slip) {
    payBox.innerHTML = `<p style="color:var(--success); font-weight:bold;">‚úîÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</p><img src="${o.payment_slip}" style="width:100%; border-radius:10px; margin-top:10px; cursor:pointer;" onclick="window.open(this.src)">`;
  } else if (o.payment_method === "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î") {
    payBox.innerHTML = `<p>üí∞ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô</p><small style="color:var(--gray)">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ‡∏ø${Number(o.cash_paid || 0).toLocaleString()}</small>`;
  } else {
    payBox.innerHTML = `
      <p style="margin-bottom:12px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="btn btn-primary" style="padding:10px;" onclick="openQRPay(${totalCalculated})">‡∏™‡πÅ‡∏Å‡∏ô QR</button>
        <button class="btn btn-outline" style="padding:10px;" onclick="openCashPay(${totalCalculated})">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
      </div>`;
  }

  // ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á
  const delSec = document.getElementById("deliverySection");
  if (o.delivery_image) {
    delSec.innerHTML = `<h3 class="section-title">üì¶ ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</h3><img src="${o.delivery_image}" class="delivery-img">`;
  } else { delSec.innerHTML = ""; }

  // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
  const isLocked = ["‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á", "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", "‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß"].includes(status);
  document.getElementById("btnAdd").style.display = isLocked ? "none" : "block";
  document.getElementById("btnEdit").style.display = isLocked ? "none" : "block";
  document.getElementById("btnCancel").style.display = isLocked ? "none" : "block";
}

/* --- üí∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô --- */

function openQRPay(total) {
  const qr = currentOrder.payment_qr || latestStoreQRUrl;
  document.getElementById("overlay").style.display = "flex";
  document.getElementById("modalContent").innerHTML = `
    <h3 style="text-align:center; color:var(--primary); margin-top:0;">‡∏™‡πÅ‡∏Å‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <p style="text-align:center; font-size:18px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <b>‡∏ø${total.toLocaleString()}</b></p>
    ${qr ? `<img src="${qr}" class="qr-img">` : '<p style="text-align:center; color:red;">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô QR</p>'}
    <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
      <label style="font-size:14px; font-weight:bold; color:var(--gray);">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô:</label>
      <input type="file" id="slipInput" accept="image/*" style="width:100%; margin-top:8px;">
    </div>
    <button class="btn btn-primary" style="margin-top:20px;" id="btnUpload" onclick="uploadSlip()" disabled>‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</button>
  `;
  document.getElementById("slipInput").onchange = e => { document.getElementById("btnUpload").disabled = !e.target.files.length; };
}

async function uploadSlip() {
  const file = document.getElementById("slipInput").files[0];
  const btn = document.getElementById("btnUpload");
  btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á..."; btn.disabled = true;

  const fname = `slip_${orderId}_${Date.now()}.png`;
  const { data, error } = await supabaseClient.storage.from("payment-slip").upload(fname, file);
  
  if (data) {
    const { data: url } = supabaseClient.storage.from("payment-slip").getPublicUrl(fname);
    await supabaseClient.from("orders").update({ payment_method: "QR", payment_slip: url.publicUrl, status: "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" }).eq("id", orderId);
    alert("‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!");
    closeOverlay();
    loadOrder();
  }
}

function openCashPay(total) {
  document.getElementById("overlay").style.display = "flex";
  document.getElementById("modalContent").innerHTML = `
    <h3 style="margin-top:0;">‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
    <p>‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡πà‡∏≤‡∏¢ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô)</p>
    <input type="number" id="cashAmt" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100, 500" style="width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; font-size:18px;">
    <button class="btn btn-primary" style="margin-top:20px;" onclick="confirmCash(${total})">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
  `;
}

async function confirmCash(total) {
  const amt = Number(document.getElementById("cashAmt").value);
  if (!amt || amt < total) return alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞");
  await supabaseClient.from("orders").update({ payment_method: "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î", cash_paid: amt, cash_change: amt - total }).eq("id", orderId);
  closeOverlay();
  loadOrder();
}

// --- ‚öôÔ∏è Real-time & Navigation ---

function subscribeRealtime() {
  supabaseClient.channel('status-monitor')
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${orderId}` }, (p) => {
      renderOrder(p.new);
    })
    .subscribe();
}

function closeOverlay() { document.getElementById("overlay").style.display = "none"; }
function backHome() { localStorage.removeItem("currentOrderId"); window.location.href = "index.html"; }
function addMore() { localStorage.setItem("appendOrderMode", "1"); window.location.href = "Menu.html"; }
function editOrder() { localStorage.setItem("appendOrderMode", "edit"); window.location.href = "Menu.html"; }

async function confirmCancelOrder() {
  if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
    await supabaseClient.from("orders").update({ status: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" }).eq("id", orderId);
    loadOrder();
  }
}

window.onload = init;
</script>
</body>
</html>