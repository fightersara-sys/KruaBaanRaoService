<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
<style>
body {
  font-family: "Tahoma", sans-serif;
  margin: 0;
  background: #fffaf5;
}

/* Header */
header {
  background: #ff6600;
  color: white;
  padding: 4px 10px;
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

header h2 {
  text-align: center;
  font-size: 16px;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

header .left, header .right {
  display: flex;
  align-items: center;
}

header button {
  background: #fff;
  color: #ff6600;
  border: none;
  border-radius: 14px;
  padding: 2px 6px;
  font-size: 13px;
  font-weight: bold;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
  white-space: nowrap;
  margin-left: 2px;
}

header button:hover {
  background: #ffe6cc;
  transform: scale(1.03);
}

/* Section */
.menu-section {
  margin: 25px 15px;
}
.menu-section h3 {
  color: #ff6600;
  background: #fff1e6;
  border-left: 5px solid #ff6600;
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 15px;
  font-size: 19px;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Grid ‡∏Å‡∏≤‡∏£‡πå‡∏î */
.menu-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
  gap: 16px;
}

.card {
  background: white;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  cursor: pointer;
  overflow: hidden;
  transition: transform 0.2s, box-shadow 0.2s;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.15);
}
img.food-img {
  width: 100%;
  aspect-ratio: 4/3;
  object-fit: cover;
}
.card-content { padding: 10px; }
.card-content h4 {
  font-size: 16px;
  margin: 5px 0;
  color: #333;
}
.price {
  color: #ff6600;
  font-weight: bold;
  font-size: 15px;
}

/* popup modal */
#modal, #cartModal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
#modal.show, #cartModal.show { display: flex; }

/* popup ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
.popup-box {
  background: white;
  padding: 20px;
  border-radius: 12px;
  width: 420px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  animation: fadeIn 0.3s ease;
}
.popup-box img {
  width: 100%;
  aspect-ratio: 4/3;
  object-fit: cover;
  border-radius: 10px;
  margin-bottom: 12px;
}
.popup-box h3 { color: #ff6600; margin-bottom: 10px; }

/* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
.option-group {
  margin-bottom: 15px;
  padding: 10px;
  border: 1px solid #ffe6cc;
  border-radius: 8px;
  background: #fff8f0;
}
.option-group h4 {
  color: #ff6600;
  font-size: 15px;
  margin: 0 0 6px 0;
  border-bottom: 1px solid #ffd1a3;
  padding-bottom: 4px;
}
.option-group label {
  display: block;
  margin: 3px 0;
  font-size: 14px;
}

/* ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô */
.quantity-box {
  margin: 10px 0;
  text-align: center;
}
.quantity-box button {
  width: 35px;
  background: #ff6600;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 18px;
  cursor: pointer;
}
.quantity-box span {
  margin: 0 10px;
  font-size: 18px;
}

/* ‡∏õ‡∏∏‡πà‡∏° */
button {
  background: #ff6600;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  margin-top: 6px;
  width: 100%;
  font-size: 15px;
}
button:hover { background: #e05500; }

/* popup ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ */
.cart-box {
  background-color: #fffdf9;
  border-radius: 20px;
  padding: 25px 20px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.2);
  border-top: 6px solid #ff6600;
  animation: fadeIn 0.3s ease;
}

.cart-item {
  background: #fff8f0;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.cart-left { display: flex; gap: 6px; align-items: center; }
.cart-name { color: #444; }
.cart-right { text-align: right; color: #ff6600; font-weight: 600; }
.cart-total-box {
  text-align: right;
  margin-top: 12px;
  padding-top: 8px;
  border-top: 2px solid #ff6600;
  font-size: 16px;
  color: #ff6600;
}
.cart-buttons button:nth-child(2) {
  background-color: #ddd;
  color: #333;
}

.cart-qty-btn {
  background: #ff6600;
  color: white;
  border: none;
  border-radius: 6px;
  width: 26px;
  height: 26px;
  cursor: pointer;
  font-size: 16px;
}

.cart-qty-btn:hover {
  background: #e05500;
}

.cart-trash {
  cursor: pointer;
  font-size: 18px;
  margin-left: 6px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
/* ===== Responsive Core ===== */
* {
  box-sizing: border-box;
}

body {
  -webkit-text-size-adjust: 100%;
}

img {
  max-width: 100%;
}

/* Card / Container */
.card,
.container,
.wrapper {
  max-width: 100%;
}

/* Buttons & inputs */
input, select, textarea, button {
  font-size: 16px; /* ‡∏Å‡∏±‡∏ô iOS zoom */
}

/* Mobile layout */
@media (max-width: 768px) {

  body {
    padding: 0;
  }

  .overlay {
    align-items: flex-start;
    padding: 12px;
  }

  .card {
    width: 100% !important;
    max-width: 420px;
    margin: 0 auto;
    padding: 20px;
    border-radius: 14px;
  }

  .title {
    font-size: 20px;
  }

  .concept {
    font-size: 13px;
  }

  button {
    padding: 14px;
    font-size: 16px;
  }

  input {
    padding: 14px;
    font-size: 16px;
  }
}
@media (max-width: 768px) {

  .menu-grid {
    display: grid;
    grid-template-columns: 1fr !important;
    gap: 12px;
  }

  .menu-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 12px;
  }

  .menu-card img {
    width: 90px;
    height: 90px;
    border-radius: 10px;
    object-fit: cover;
  }

  .menu-card h4 {
    font-size: 16px;
    margin-bottom: 4px;
  }

  .menu-card p {
    font-size: 13px;
    color: #666;
  }

  .cart {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -5px 20px rgba(0,0,0,.1);
    max-height: 60vh;
    overflow-y: auto;
    z-index: 50;
  }

  .cart-footer {
    position: sticky;
    bottom: 0;
    background: white;
    padding: 12px;
    border-top: 1px solid #eee;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
<script>
const supabaseUrl = "https://vxutzcrwqbnkcwxtdphy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4dXR6Y3J3cWJua2N3eHRkcGh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzkzNDQsImV4cCI6MjA3NTA1NTM0NH0.zwbcu_4eGAiRTaX7QBwgrJhWgCda58FW-boeJM-ZlKg";
const supabaseClient=supabase.createClient(supabaseUrl,supabaseKey);

let cart=[], currentFood=null, houseNo;
let optionsData={}, menuOptionsMap={};
let currentQty = 1;
let defaultFoodImage = "";
let appendMode = false;
let appendOrderId = null;
let currentOrderId = localStorage.getItem("currentOrderId");
currentOrderId = currentOrderId ? Number(currentOrderId) : null;

async function guardShopOpen() {
  try {
    const { data: shop } = await supabaseClient
      .from("shop_settings")
      .select("is_open")
      .eq("id", 1)
      .maybeSingle();

    const isOpen = shop?.is_open !== false;

    const { data: store } = await supabaseClient
      .from("store_settings")
      .select("open_time, close_time")
      .eq("id", 1)
      .maybeSingle();

    const timeOK = store
      ? isWithinOpenTime(store.open_time, store.close_time)
      : true;

    if (!isOpen || !timeOK) {
      document.body.innerHTML = `
        <div style="
          height:100vh;
          display:flex;
          align-items:center;
          justify-content:center;
          font-size:32px;
          color:#ff4d4f;
          background:#111;
          flex-direction:column;
        ">
          <div>üö´ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏à‡πâ‡∏≤</div>
        </div>
      `;
      throw new Error("Shop closed");
    }

  } catch (e) {
    console.error("guardShopOpen", e);
    throw e;
  }
}

function isWithinOpenTime(open, close) {
  if (!open || !close) return true;

  const now = new Date();
  const [oh, om] = open.split(":").map(Number);
  const [ch, cm] = close.split(":").map(Number);

  const start = new Date();
  start.setHours(oh, om, 0, 0);

  const end = new Date();
  end.setHours(ch, cm, 0, 0);

  return now >= start && now <= end;
}

async function init(){
  await guardShopOpen();
  houseNo = localStorage.getItem("houseNumber") || "";
  document.getElementById("houseNo").innerText = houseNo || "-";

  const { data: store } = await supabaseClient
    .from("store_settings")
    .select("logo_url")
    .eq("id", 1)
    .single();

  if (store?.logo_url) {
    defaultFoodImage = store.logo_url;
  }

  appendMode = localStorage.getItem("appendOrderMode") === "1";
  appendOrderId = Number(localStorage.getItem("currentOrderId")) || null;

  // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π
  const { data: menus } = await supabaseClient.from("menus").select("*").eq("visible", true);

  // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
  const { data: opts } = await supabaseClient.from("options").select("*").eq("visible", true);

  // ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ option ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
  const { data: menuOpts } = await supabaseClient
        .from("menu_options")
        .select("menu_id, option_id");

  // ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
  const { data: menuGroups } = await supabaseClient
        .from("menu_option_groups")
        .select("menu_id, group_id");

  // ‡∏Å‡∏•‡∏∏‡πà‡∏° options => key: group_id
  optionsData = (opts || []).reduce((acc, o) => {
    if (!acc[o.group_id]) acc[o.group_id] = [];
    acc[o.group_id].push(o);
    return acc;
  }, {});

  // ‡∏ú‡∏π‡∏Å‡πÄ‡∏°‡∏ô‡∏π -> option_id list
  menuOptionsMap = (menuOpts || []).reduce((acc, row) => {
    if (!acc[row.menu_id]) acc[row.menu_id] = [];
    acc[row.menu_id].push(row.option_id);
    return acc;
  }, {});

  // ‡∏ú‡∏π‡∏Å‡πÄ‡∏°‡∏ô‡∏π -> group_id list
  menuGroupsMap = (menuGroups || []).reduce((acc, row) => {
    if (!acc[row.menu_id]) acc[row.menu_id] = [];
    acc[row.menu_id].push(row.group_id);
    return acc;
  }, {});

  renderMenus(menus || []);
}

function getCategoryIcon(cat){
  switch(cat){
    case "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß": return "üçõ";
    case "‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡πâ‡∏°": return "üç≤";
    case "‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡∏≥": return "ü•ó";
    default: return "üçΩÔ∏è";
  }
}

function renderMenus(menus){
  const container=document.getElementById("menuList");
  container.innerHTML="";
  const grouped={};
  menus.forEach(m=>{
    const cat=m.category||"‡∏≠‡∏∑‡πà‡∏ô ‡πÜ";
    if(!grouped[cat]) grouped[cat]=[];
    grouped[cat].push(m);
  });

  const order=["‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß","‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡πâ‡∏°","‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡∏≥"];
  const sortedCats=Object.keys(grouped).sort((a,b)=>{
    const ai=order.indexOf(a), bi=order.indexOf(b);
    if(ai===-1&&bi===-1) return a.localeCompare(b);
    if(ai===-1) return 1;
    if(bi===-1) return -1;
    return ai-bi;
  });

  sortedCats.forEach(cat=>{
    const sec=document.createElement("div");
    sec.className="menu-section";
    sec.innerHTML=`<h3>${getCategoryIcon(cat)} ${cat}</h3>`;
    const grid=document.createElement("div");
    grid.className="menu-container";
    grouped[cat].forEach(m=>{
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <img 
          src="${m.image_url || defaultFoodImage}" 
          class="food-img"
          onerror="this.src='${defaultFoodImage}'"
        />
        <div class="card-content">
          <h4>${m.name}</h4>
          <p class="price">‡∏ø${m.price}</p>
        </div>`;
      div.onclick=()=>openModal(m);
      grid.appendChild(div);
    });
    sec.appendChild(grid);
    container.appendChild(sec);
  });
}

function openModal(food){
  currentFood=food;
  currentQty=1;
  document.getElementById("qtyValue").innerText=currentQty;
  document.getElementById("modalTitle").innerText=food.name;
  document.getElementById("modalImage").src =
  food.image_url || defaultFoodImage;
  renderOptions(food.id);
  document.getElementById("modal").classList.add("show");
  document.getElementById("foodNote").value = "";
}
function changeQuantity(delta){
  currentQty+=delta;
  if(currentQty<1) currentQty=1;
  document.getElementById("qtyValue").innerText=currentQty;
}
function closeModal(){ document.getElementById("modal").classList.remove("show"); }

function renderOptions(menuId){
  const container = document.getElementById("optionsContainer");
  container.innerHTML = "";

  const useGroups = menuGroupsMap[menuId] || [];
  const allowOptions = menuOptionsMap[menuId] || [];

  if (useGroups.length === 0) {
    container.innerHTML = "<p style='color:#666;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>";
    return;
  }

  useGroups.forEach(gid => {
    const groupOptions = (optionsData[gid] || []).filter(o => allowOptions.includes(o.id));
    if (groupOptions.length === 0) return;

    const wrap = document.createElement("div");
    wrap.className = "option-group";
    wrap.innerHTML = `<h4> ${groupOptions[0].type || "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"} </h4>`;

    groupOptions.forEach(o => {
      const lbl = document.createElement("label");
      lbl.innerHTML = `
        <input type="checkbox" data-option-id="${o.id}"data-option-name="${o.name}"data-option-price="${o.price}">
        ${o.name}${o.price ? ` (+${o.price})` : ""}
      `;
      wrap.appendChild(lbl);
    });

    container.appendChild(wrap);
  });
}

function addToCart(){
  if(!currentFood) return;

  let base = Number(currentFood.price) || 0;
  let desc = currentFood.name;
  let add = 0;
  const selectedOptions = [];
  let optionDesc = [];
  let optionTotal = 0;

  document.querySelectorAll("#optionsContainer input:checked").forEach(chk=>{
    const optId = Number(chk.dataset.optionId);
    const optName = chk.dataset.optionName;
    const optPrice = Number(chk.dataset.optionPrice || 0);

    selectedOptions.push({ id: optId });   // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
    optionDesc.push(optName);
    optionTotal += optPrice;
  });

  // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
  const note = document.getElementById("foodNote").value.trim();

  const unitPrice = base + optionTotal;

cart.push({
  menu_id: currentFood.id,
  food: currentFood.name,
  price: base,          // ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  unit_price: unitPrice, // ‚≠ê ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏¥‡πâ‡∏ô ‡∏£‡∏ß‡∏° option
  qty: currentQty,
  options: selectedOptions,
  note: note,
  total: unitPrice * currentQty
});

  document.getElementById("cartCount").innerText = cart.length;
  closeModal();
}

function updateCartQty(index, delta){
  cart[index].qty += delta;
  if(cart[index].qty < 1) cart[index].qty = 1;

  cart[index].total = cart[index].unit_price * cart[index].qty;

  openCart();
}

function removeCartItem(index){
  if(!confirm("‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ?")) return;
  cart.splice(index,1);
  document.getElementById("cartCount").innerText = cart.length;
  openCart();
}

function openCart(){
  const box=document.getElementById("cartItems");
  box.innerHTML="";
  if(cart.length===0){
    box.innerHTML="<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>";
  }else{
    let total=0;
    cart.forEach((c,i)=>{
      total+=c.total;
      box.innerHTML += `
  <div class="cart-item">
    <div class="cart-left">
      <span>${i+1}.</span>
      <div>
        <div>${c.food}</div>
        ${c.options?.length
          ? `<div style="font-size:12px;color:#999;">
              ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${c.options.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </div>`
          : ""
        }
        ${c.note ? `<div style="font-size:12px;color:#999;">üìù ${c.note}</div>` : ""}
      </div>
    </div>
    <div class="cart-right">
      <div style="display:flex; align-items:center; gap:4px; justify-content:flex-end;">
        <button class="cart-qty-btn" onclick="updateCartQty(${i},-1)">‚àí</button>
        <span>${c.qty}</span>
        <button class="cart-qty-btn" onclick="updateCartQty(${i},1)">+</button>
        <span class="cart-trash" onclick="removeCartItem(${i})">üóëÔ∏è</span>
      </div>
      <div>‡∏ø${c.total}</div>
    </div>
  </div>`;
    });
    box.innerHTML+=`<div class="cart-total-box"><b>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</b> ‡∏ø${total}</div>`;
  }
  document.getElementById("cartModal").classList.add("show");
}
function closeCart(){ document.getElementById("cartModal").classList.remove("show"); }

async function confirmOrder(){
  if(cart.length === 0){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  const totalAdd = cart.reduce((a,b)=>a+b.total,0);

  console.log("APPEND MODE:", appendMode, appendOrderId);

  // ‚≠ê ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£
  if(appendMode && appendOrderId){

    // 1. ‡πÇ‡∏´‡∏•‡∏î order ‡πÄ‡∏î‡∏¥‡∏°
    const { data: oldOrder, error: loadErr } = await supabaseClient
      .from("orders")
      .select("items, total")
      .eq("id", appendOrderId)
      .single();

    if(loadErr || !oldOrder){
      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°");
      return;
    }

    // 2. ‡∏£‡∏ß‡∏° items
    const mergedItems = [
      ...(Array.isArray(oldOrder.items) ? oldOrder.items : []),
      ...cart
    ];

    const newTotal = Number(oldOrder.total || 0) + totalAdd;

    // 3. update order ‡πÄ‡∏î‡∏¥‡∏°
    const { error: updateErr } = await supabaseClient
      .from("orders")
      .update({
        items: mergedItems,
        total: newTotal
      })
      .eq("id", appendOrderId);

    if(updateErr){
      alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + updateErr.message);
      return;
    }

    // 4. clear flag
    localStorage.removeItem("appendOrderMode");

    // 5. ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ order-status
    window.location.href = "order-status.html";
    return;
  }

  // ‚≠ê ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏™‡∏£‡πâ‡∏≤‡∏á order ‡πÉ‡∏´‡∏°‡πà)
  const total = cart.reduce((a,b)=>a+b.total,0);

  const { data,error } = await supabaseClient
    .from("orders")
    .insert([{
      house: houseNo,
      items: cart,
      total,
      status: "‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"
    }])
    .select();

  if(error){
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+error.message);
    return;
  }

  localStorage.setItem("currentOrderId", data[0].id);
  window.location.href = "order-status.html";
}
window.addEventListener("load", async () => {
  await guardShopOpen();
  init(); // init ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á Menu
});
</script>
</head>

<body>
<header>
  <div class="left"><button onclick="window.location.href='index.html'">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button></div>
  <h2>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£ | ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <span id="houseNo"></span></h2>
  <div class="right cart-btn" onclick="openCart()">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ üõí <span id="cartCount">0</span></div>
</header>

<div id="menuList"></div>

<!-- Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π -->
<div id="modal">
  <div class="popup-box">
    <img id="modalImage" src="" onerror="this.onerror=null; this.src=defaultFoodImage;">
    <h3 id="modalTitle"></h3>
    <div id="optionsContainer"></div>
    <div class="quantity-box">
      <button onclick="changeQuantity(-1)">‚ûñ</button>
      <span id="qtyValue">1</span>
      <button onclick="changeQuantity(1)">‚ûï</button>
    </div>
    <textarea id="foodNote" 
  placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î, ‡πÅ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥, ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏Ç‡πà, ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ú‡∏±‡∏Å"
  style="
    width:100%;
    height:70px;
    margin-top:10px;
    padding:8px;
    border:1px solid #ccc;
    border-radius:8px;
    font-size:14px;
    resize: none;
  ">
</textarea>
    <button onclick="addToCart()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
    <button onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<!-- Modal ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ -->
<div id="cartModal">
  <div class="cart-box">
    <h3 style="text-align:center;">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
    <div id="cartItems"></div>
    <div class="cart-buttons">
      <button onclick="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
      <button onclick="closeCart()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>
</body>
</html>
